# /etc/nginx/sites-available/founderos
#
# Nginx reverse proxy for the FounderOS API.
# Terminates HTTPS via Let's Encrypt, proxies to Gunicorn on :8000.
#
# Install:
#   sudo cp nginx-founderos.conf /etc/nginx/sites-available/founderos
#   sudo ln -s /etc/nginx/sites-available/founderos /etc/nginx/sites-enabled/
#   sudo nginx -t && sudo systemctl reload nginx
#
# Then set up SSL:
#   sudo certbot --nginx -d api.founderos.app

# Redirect HTTP → HTTPS (Certbot will manage this after cert issuance)
server {
    listen 80;
    server_name api.founderos.app;

    # Let Certbot handle the redirect after SSL is set up.
    # Before SSL, this proxies directly so you can test.
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE support (streaming chat responses)
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        # File uploads up to 50 MB
        client_max_body_size 50M;
    }

    # Health check — quick bypass for monitoring
    location = /api/health {
        proxy_pass http://127.0.0.1:8000;
        proxy_read_timeout 5s;
    }

    # Block dotfiles
    location ~ /\. {
        deny all;
        return 404;
    }
}

# HTTPS — Certbot will generate this block after you run:
#   sudo certbot --nginx -d api.founderos.app
#
# It will automatically:
#  - Add ssl_certificate / ssl_certificate_key directives
#  - Redirect the HTTP server block to HTTPS
#  - Add the listen 443 ssl block below
#
# If you want to configure it manually, uncomment the block below
# and replace paths with your cert paths.
#
# server {
#     listen 443 ssl http2;
#     server_name api.founderos.app;
#
#     ssl_certificate     /etc/letsencrypt/live/api.founderos.app/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/api.founderos.app/privkey.pem;
#     include             /etc/letsencrypt/options-ssl-nginx.conf;
#     ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;
#
#     add_header X-Frame-Options DENY always;
#     add_header X-Content-Type-Options nosniff always;
#     add_header Referrer-Policy strict-origin-when-cross-origin always;
#
#     client_max_body_size 50M;
#
#     location / {
#         proxy_pass http://127.0.0.1:8000;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_buffering off;
#         proxy_cache off;
#         proxy_read_timeout 300s;
#         proxy_send_timeout 300s;
#     }
#
#     location = /api/health {
#         proxy_pass http://127.0.0.1:8000;
#         proxy_read_timeout 5s;
#     }
#
#     location ~ /\. {
#         deny all;
#         return 404;
#     }
# }
